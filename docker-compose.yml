services:
  # Backend сервис
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bazar-monitoring-backend
    ports:
      - "5000:5000"
    volumes:
      # Монтируем volume для сохранения БД
      - bazar-db:/app/instance
      # Монтируем код для разработки (hot reload)
      - ./backend:/app
    entrypoint: ["sh", "-c", "chmod +x /app/docker-entrypoint.sh && /app/docker-entrypoint.sh"]
    environment:
      - SQLALCHEMY_DATABASE_URI=sqlite:////app/instance/bazar_monitoring.db
      - FLASK_ENV=production
    restart: unless-stopped
    networks:
      - bazar-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://backend:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend сервис
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: bazar-monitoring-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - bazar-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://frontend/"]
      interval: 30s
      timeout: 10s
      retries: 3

# Volumes для постоянного хранения данных
volumes:
  bazar-db:
    driver: local

# Сеть для связи между контейнерами
networks:
  bazar-network:
    driver: bridge

