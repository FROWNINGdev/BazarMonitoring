# Bazar Monitoring Backend

Flask-based backend для системы мониторинга базаров Узбекистана.

## Возможности

- ✅ REST API для мониторинга базаров
- ✅ SQLite база данных для логирования
- ✅ Автоматическое отслеживание изменений статуса (online/offline)
- ✅ История событий и проблем
- ✅ Статистика и аналитика

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Запустите сервер:
```bash
python app.py
```

Сервер запустится на `http://localhost:5000`

## API Endpoints

### GET /api/bazars
Получить текущий статус всех базаров (проверяет напрямую и логирует изменения)

**Response:**
```json
{
  "success": true,
  "data": [...],
  "total": 14,
  "online": 10,
  "offline": 4
}
```

### GET /api/logs
Получить все логи изменений статуса

**Query параметры:**
- `limit` - количество записей (по умолчанию: 100)
- `status` - фильтр по статусу (online/offline)

### GET /api/logs/<ip>/<port>
Получить логи конкретного базара

**Query параметры:**
- `limit` - количество записей (по умолчанию: 50)

### GET /api/status
Получить текущий статус всех базаров из БД (без проверки)

### GET /api/statistics
Получить общую статистику системы

### GET /api/health
Проверка работоспособности API

## База данных

### Таблица: bazar_log
Хранит историю изменений статуса базаров:
- `id` - уникальный идентификатор
- `bazar_name` - название базара
- `bazar_ip` - IP адрес
- `bazar_port` - порт
- `city` - город
- `status` - текущий статус (online/offline)
- `previous_status` - предыдущий статус
- `error_message` - сообщение об ошибке (если есть)
- `timestamp` - время события

### Таблица: bazar_status
Хранит текущий статус базаров:
- `id` - уникальный идентификатор
- `bazar_name` - название базара
- `bazar_ip` - IP адрес
- `bazar_port` - порт фронтенда
- `backend_port` - порт backend API
- `pg_port` - порт PostgreSQL
- `city` - город
- `status` - текущий статус
- `last_online` - время последнего online
- `last_offline` - время последнего offline
- `last_check` - время последней проверки
- `uptime_percentage` - процент доступности

## Примеры использования

```bash
# Проверить все базары
curl http://localhost:5000/api/bazars

# Получить логи
curl http://localhost:5000/api/logs?limit=50

# Получить логи конкретного базара
curl http://localhost:5000/api/logs/192.168.168.37/80

# Статистика
curl http://localhost:5000/api/statistics
```

## Автоматическое логирование

Система автоматически логирует:
- ✅ Переход базара из online в offline
- ✅ Переход базара из offline в online
- ✅ Ошибки подключения с описанием
- ✅ Время каждого события

Это позволяет отслеживать:
- Когда базар отключился
- Когда базар снова включился
- Какие проблемы возникали
- Частоту проблем

