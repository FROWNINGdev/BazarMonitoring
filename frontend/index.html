<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bozor Monitoring System</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Preview overlay -->
    <div id="previewOverlay" class="preview-overlay">
        <video id="previewVideo" class="preview-video" src="preview/preview.mp4" autoplay muted playsinline></video>
        <button id="skipPreviewBtn" class="preview-skip" aria-label="Пропустить превью">
            <i class="fas fa-forward"></i>
            <span>Пропустить</span>
        </button>
    </div>

    <!-- Particles Background -->
    <div id="particles-js"></div>
    
    <!-- Top Navigation -->
    <header class="top-nav">
        <div class="nav-container">
            <!-- Global Search & Filters -->
            <div class="control-bar">
                <div class="search-container">
                    <i class="fas fa-magnifying-glass"></i>
                    <input
                        type="text"
                        id="searchInput"
                        data-i18n-placeholder="dashboard.search"
                        placeholder="Search markets, locations, endpoints...">
                </div>

                <div class="filter-group">
                    <div class="filter-item">
                        <label>
                            <i class="fas fa-location-dot"></i>
                            <span data-i18n="dashboard.filterByCity">Location</span>
                        </label>
                        <select id="cityFilter">
                            <option value="all" data-i18n="dashboard.allLocations">All Locations</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <label>
                            <i class="fas fa-signal"></i>
                            <span data-i18n="dashboard.filterByStatus">Status</span>
                        </label>
                        <select id="statusFilter">
                            <option value="all" data-i18n="dashboard.allStatuses">All Status</option>
                            <option value="online" data-i18n="dashboard.online">Online</option>
                            <option value="offline" data-i18n="dashboard.offline">Offline</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="nav-actions">
                <button id="mapBtn" class="nav-btn map-btn">
                    <i class="fas fa-map"></i>
                    <span data-i18n="nav.map">Карта</span>
                </button>
                <button id="themeToggleBtn" class="nav-btn theme-toggle-btn">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="langToggle" class="nav-btn lang-toggle">
                    <i class="fas fa-globe"></i>
                    <span id="currentLang">RU</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar Open Button (shown when sidebar is closed) -->
    <button id="sidebarOpenBtn" class="sidebar-open-btn" onclick="toggleSidebar()">
        <i class="fas fa-chevron-right"></i>
    </button>

    <!-- Sidebar Menu -->
    <div id="sidebarMenu" class="sidebar-menu">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-body">
                <div class="sidebar-section">
                    <h4 data-i18n="sidebar.statistics">Статистика</h4>
                    <button id="generalStatsBtn" class="sidebar-btn">
                        <i class="fas fa-chart-bar"></i>
                        <span data-i18n="nav.generalStats">Общая статистика</span>
                    </button>
                </div>
                
                
                <div class="sidebar-section">
                    <h4 data-i18n="sidebar.external">Внешние сервисы</h4>
                    <a href="http://192.168.168.36:3000/d/rYdddlPWk/bozor-monitoring-dashboards?orgId=1&from=now-24h&to=now&timezone=browser&var-ds_prometheus=cf10datz6wzy8b&var-job=servers&var-nodename=Surxondaryo&var-node=192.168.168.56:9100&refresh=1m" 
                       target="_blank" 
                       class="sidebar-btn">
                        <i class="fas fa-chart-line"></i>
                        <span data-i18n="nav.analytics">Аналитика</span>
                    </a>
                    <a href="http://192.168.168.36:9000/#!/home" 
                       target="_blank" 
                       class="sidebar-btn">
                        <i class="fas fa-cubes"></i>
                        <span data-i18n="nav.containers">Контейнеры</span>
                    </a>
                </div>
                
                <div class="sidebar-section">
                    <h4 data-i18n="sidebar.management">Управление</h4>
                    <button class="sidebar-btn" onclick="showAddServiceModal()">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="nav.addService">Добавить базар</span>
                    </button>
                    <button class="sidebar-btn" onclick="showLogsModal()">
                        <i class="fas fa-list"></i>
                        <span data-i18n="nav.logs">Логи</span>
                    </button>
                    <button class="sidebar-btn" onclick="showTelegramChatIdsModal()">
                        <i class="fab fa-telegram"></i>
                        <span>Telegram Chat ID</span>
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <h4 data-i18n="sidebar.calendar">Календарь</h4>
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="current-date-info">
                                <div class="current-date-box" id="currentDateBox">
                                    <span id="currentDay">--</span>
                                </div>
                                <div class="month-info">
                                    <h2 id="currentMonth">--</h2>
                                    <div class="text-animation-container">
                                        <p id="currentYear">----</p>
                                    </div>
                                </div>
                            </div>
                            <div class="add-button" onclick="toggleCalendar()">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                        
                        <div class="weekdays">
                            <span data-i18n="calendar.weekdays.monday">Пн</span>
                            <span data-i18n="calendar.weekdays.tuesday">Вт</span>
                            <span data-i18n="calendar.weekdays.wednesday">Ср</span>
                            <span data-i18n="calendar.weekdays.thursday">Чт</span>
                            <span data-i18n="calendar.weekdays.friday">Пт</span>
                            <span data-i18n="calendar.weekdays.saturday">Сб</span>
                            <span data-i18n="calendar.weekdays.sunday">Вс</span>
                        </div>
                        
                        <div class="days-container expanded" id="daysContainer">
                            <!-- Days will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <main class="dashboard">
        <div class="dashboard-container">
            <!-- Status Overview -->
            <section class="status-section">
                <div class="section-title-bar">
                    <h2 data-i18n="dashboard.systemOverview">Статус базаров</h2>
                    <button id="refreshBtn" class="btn-refresh">
                        <i class="fas fa-rotate"></i>
                        <span data-i18n="dashboard.refresh">Обновить</span>
                    </button>
                </div>

                <div class="status-grid">
                    <div class="status-card total">
                        <div class="status-progress">
                            <svg>
                                <circle class="progress-ring progress-ring-bg" cx="40" cy="40" r="34"></circle>
                                <circle class="progress-ring progress-ring-fill" cx="40" cy="40" r="34" id="totalProgress"></circle>
                            </svg>
                            <div class="progress-text" id="totalProgressText">--/--</div>
                        </div>
                        <div class="status-card-info">
                            <div class="status-card-title" data-i18n="dashboard.allBozor">Все базары</div>
                            <div class="status-card-status">
                                <div class="status-dot"></div>
                                <span data-i18n="dashboard.total">Всего</span>
                            </div>
                        </div>
                    </div>

                    <div class="status-card online">
                        <div class="status-progress">
                            <svg>
                                <circle class="progress-ring progress-ring-bg" cx="40" cy="40" r="34"></circle>
                                <circle class="progress-ring progress-ring-fill" cx="40" cy="40" r="34" id="onlineProgress"></circle>
                            </svg>
                            <div class="progress-text" id="onlineProgressText">--/--</div>
                        </div>
                        <div class="status-card-info">
                            <div class="status-card-title" data-i18n="dashboard.online">Онлайн</div>
                            <div class="status-card-status">
                                <div class="status-dot"></div>
                                <span data-i18n="dashboard.operational">Работает</span>
                            </div>
                        </div>
                    </div>

                    <div class="status-card offline">
                        <div class="status-progress">
                            <svg>
                                <circle class="progress-ring progress-ring-bg" cx="40" cy="40" r="34"></circle>
                                <circle class="progress-ring progress-ring-fill" cx="40" cy="40" r="34" id="offlineProgress"></circle>
                            </svg>
                            <div class="progress-text" id="offlineProgressText">--/--</div>
                        </div>
                        <div class="status-card-info">
                            <div class="status-card-title" data-i18n="dashboard.offline">Оффлайн</div>
                            <div class="status-card-status">
                                <div class="status-dot"></div>
                                <span data-i18n="dashboard.requiresAction">Требует внимания</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- Map Modal -->
            <div id="mapModal" class="map-modal">
                <div class="map-modal-overlay"></div>
                <div class="map-modal-content">
                    <div class="map-modal-header">
                        <h2 data-i18n="nav.map">Карта базаров</h2>
                        <div class="map-modal-actions">
                            <button id="fullscreenMapBtn" class="map-modal-fullscreen" title="Полноэкранный режим">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button id="closeMapBtn" class="map-modal-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="map-modal-body">
                        <div id="uzbekistanMap" class="map-view"></div>
                        
                        <!-- General Overview Sidebar -->
                        <div class="general-overview">
                            <div class="overview-header">
                                <h3 data-i18n="dashboard.generalOverview">Общий обзор</h3>
                                <button class="overview-toggle" id="overviewToggle">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="overview-content" id="overviewContent">
                                <div class="overview-section">
                                    <div class="overview-section-header">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span data-i18n="dashboard.bazars">Базары</span>
                                    </div>
                                    <div class="overview-stats">
                                        <div class="overview-stat">
                                            <div class="stat-dot online"></div>
                                            <span class="stat-label" data-i18n="dashboard.online">Онлайн</span>
                                            <span class="stat-value" id="overviewOnline">0</span>
                                        </div>
                                        <div class="overview-stat">
                                            <div class="stat-dot offline"></div>
                                            <span class="stat-label" data-i18n="dashboard.offline">Оффлайн</span>
                                            <span class="stat-value" id="overviewOffline">0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="overview-section">
                                    <div class="overview-section-header">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span data-i18n="dashboard.api">API</span>
                                    </div>
                                    <div class="overview-stats">
                                        <div class="overview-stat">
                                            <div class="stat-dot online"></div>
                                            <span class="stat-label" data-i18n="dashboard.online">Онлайн</span>
                                            <span class="stat-value" id="overviewApiOnline">0</span>
                                        </div>
                                        <div class="overview-stat">
                                            <div class="stat-dot offline"></div>
                                            <span class="stat-label" data-i18n="dashboard.offline">Оффлайн</span>
                                            <span class="stat-value" id="overviewApiOffline">0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="overview-section">
                                    <div class="overview-section-header">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span data-i18n="dashboard.database">База данных</span>
                                    </div>
                                    <div class="overview-stats">
                                        <div class="overview-stat">
                                            <div class="stat-dot online"></div>
                                            <span class="stat-label" data-i18n="dashboard.online">Онлайн</span>
                                            <span class="stat-value" id="overviewDbOnline">0</span>
                                        </div>
                                        <div class="overview-stat">
                                            <div class="stat-dot offline"></div>
                                            <span class="stat-label" data-i18n="dashboard.offline">Оффлайн</span>
                                            <span class="stat-value" id="overviewDbOffline">0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cameras Statistics Section -->
                                <div class="map-overview-cameras">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Statistics Modal -->
            <div id="generalStatsModal" class="stats-modal">
                <div class="stats-modal-overlay"></div>
                <div class="stats-modal-content">
                    <div class="stats-modal-header">
                        <h2 data-i18n="statistics.title">Общая статистика базаров</h2>
                        <div class="stats-modal-actions">
                            <button class="export-excel-btn" onclick="exportToExcel().catch(console.error)" title="Экспорт в Excel">
                                <i class="fas fa-file-excel"></i>
                            </button>
                            <button class="map-modal-close" onclick="closeGeneralStats()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="stats-modal-body">
                        <!-- Общая статистика -->
                        <div class="stats-overview-section">
                            <h3 data-i18n="statistics.overview">Общая статистика</h3>
                            <div class="stats-overview-grid">
                                <div class="stats-overview-card">
                                    <div class="stats-overview-icon">
                                        <i class="fas fa-store"></i>
                                    </div>
                                    <div class="stats-overview-info">
                                        <div class="stats-overview-number" id="totalBazarsStats">0</div>
                                        <div class="stats-overview-label" data-i18n="statistics.totalBazars">Всего базаров</div>
                                    </div>
                                </div>
                                <div class="stats-overview-card online">
                                    <div class="stats-overview-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="stats-overview-info">
                                        <div class="stats-overview-number" id="onlineBazarsStats">0</div>
                                        <div class="stats-overview-label" data-i18n="statistics.onlineBazars">Онлайн</div>
                                    </div>
                                </div>
                                <div class="stats-overview-card offline">
                                    <div class="stats-overview-icon">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="stats-overview-info">
                                        <div class="stats-overview-number" id="offlineBazarsStats">0</div>
                                        <div class="stats-overview-label" data-i18n="statistics.offlineBazars">Оффлайн</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Статистика камер -->
                        <div class="stats-cameras-section">
                            <h3 data-i18n="statistics.cameras">Статистика камер</h3>
                            <div class="stats-cameras-grid">
                                <div class="stats-cameras-card">
                                    <div class="stats-cameras-icon">
                                        <i class="fas fa-video"></i>
                                    </div>
                                    <div class="stats-cameras-info">
                                        <div class="stats-cameras-number" id="totalCamerasStats">0</div>
                                        <div class="stats-cameras-label" data-i18n="statistics.totalCameras">Всего камер</div>
                                    </div>
                                </div>
                                <div class="stats-cameras-card online">
                                    <div class="stats-cameras-icon">
                                        <i class="fas fa-video"></i>
                                    </div>
                                    <div class="stats-cameras-info">
                                        <div class="stats-cameras-number" id="onlineCamerasStats">0</div>
                                        <div class="stats-cameras-label" data-i18n="statistics.workingCameras">Работает</div>
                                    </div>
                                </div>
                                <div class="stats-cameras-card offline">
                                    <div class="stats-cameras-icon">
                                        <i class="fas fa-video-slash"></i>
                                    </div>
                                    <div class="stats-cameras-info">
                                        <div class="stats-cameras-number" id="offlineCamerasStats">0</div>
                                        <div class="stats-cameras-label" data-i18n="statistics.notWorkingCameras">Не работает</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Статистика по областям -->
                        <div class="stats-regions-section">
                            <h3 data-i18n="statistics.byRegions">Статистика по областям</h3>
                            <div class="stats-regions-list" id="statsRegionsList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Детальная статистика по базарам -->
                        <div class="stats-detailed-section">
                            <h3 data-i18n="statistics.detailed">Детальная статистика по базарам</h3>
                            <div class="stats-detailed-list" id="statsDetailedList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Service Modal -->
            <div id="addServiceModal" class="admin-modal">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <div class="admin-modal-title">
                            <i class="fas fa-plus"></i>
                            <h2>Добавить новый сервис</h2>
                        </div>
                        <div class="admin-modal-actions">
                            <button id="closeAddServiceBtn" class="admin-modal-close">
                                <i class="fas fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="admin-modal-body">
                        <div class="admin-section">
                            <form id="addServiceForm" class="admin-form">
                                <!-- Основные поля -->
                                <div class="form-row">
                                        <div class="form-group">
                                            <label for="serviceName">Название сервиса</label>
                                            <input type="text" id="serviceName" name="name" placeholder="Например: MIROBOD DEHQON BOZORI">
                                        </div>
                                        <div class="form-group">
                                            <label for="serviceCity">Город</label>
                                            <input type="text" id="serviceCity" name="city" placeholder="Например: Tashkent">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="serviceIp">IP адрес</label>
                                            <input type="text" id="serviceIp" name="ip" placeholder="192.168.168.37" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="servicePort">Порт фронтенда</label>
                                            <input type="number" id="servicePort" name="port" placeholder="80" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="serviceBackendPort">Порт backend API</label>
                                            <input type="number" id="serviceBackendPort" name="backend_port" placeholder="8200" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="servicePgPort">Порт PostgreSQL</label>
                                            <input type="number" id="servicePgPort" name="pg_port" placeholder="5400" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="serviceStreamPort">Порт Stream</label>
                                            <input type="number" id="serviceStreamPort" name="stream_port" placeholder="8554">
                                        </div>
                                        <div class="form-group">
                                            <!-- Empty column for alignment -->
                                        </div>
                                    </div>
                                
                                <!-- Раскрывающаяся секция "Дополнительно" -->
                                <div class="form-collapsible">
                                    <button type="button" class="form-collapsible-toggle" id="toggleAdditional">
                                        <i class="fas fa-chevron-down"></i>
                                        <span>Дополнительно (контакты, координаты)</span>
                                    </button>
                                    
                                    <div class="form-collapsible-content" id="additionalContent">
                                        <div class="form-section-title">
                                            <i class="fas fa-phone"></i>
                                            <h4>Контактная информация</h4>
                                        </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="serviceContactClickName">Имя контакта Click</label>
                                            <input type="text" id="serviceContactClickName" name="contact_click_name" data-i18n-placeholder="modal.addService.contactClickNamePlaceholder" placeholder="Например: Иван Иванов">
                                        </div>
                                        <div class="form-group">
                                            <label for="serviceContactClick">Телефон Click</label>
                                            <div class="phone-input">
                                                <span class="phone-prefix">+998</span>
                                                <input type="tel" id="serviceContactClick" name="contact_click" placeholder="901234567" pattern="[0-9]{9}" maxlength="9">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="serviceContactSccName">Имя контакта SCC</label>
                                            <input type="text" id="serviceContactSccName" name="contact_scc_name" data-i18n-placeholder="modal.addService.contactSccNamePlaceholder" placeholder="Например: Петр Петров">
                                        </div>
                                        <div class="form-group">
                                            <label for="serviceContactScc">Телефон SCC</label>
                                            <div class="phone-input">
                                                <span class="phone-prefix">+998</span>
                                                <input type="tel" id="serviceContactScc" name="contact_scc" placeholder="901234567" pattern="[0-9]{9}" maxlength="9">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-section-title">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <h4>Координаты на карте</h4>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="serviceLatitude">Широта</label>
                                            <input type="text" id="serviceLatitude" name="latitude" placeholder="41.291173" pattern="^-?\d+\.?\d*$">
                                        </div>
                                        <div class="form-group">
                                            <label for="serviceLongitude">Долгота</label>
                                            <input type="text" id="serviceLongitude" name="longitude" placeholder="69.274854" pattern="^-?\d+\.?\d*$">
                                        </div>
                                    </div>
                                    </div>
                                </div>
                                    
                                <div class="form-actions">
                                        <button type="submit" class="btn-submit">
                                            <i class="fas fa-save"></i>
                                            <span>Сохранить сервис</span>
                                        </button>
                                        <button type="button" id="cancelAddService" class="btn-cancel">
                                            <i class="fas fa-times"></i>
                                            <span>Отмена</span>
                                        </button>
                                    </div>
                                </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Service Modal -->
            <div id="editServiceModal" class="admin-modal">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <div class="admin-modal-title">
                            <i class="fas fa-pencil"></i>
                            <h2 data-i18n="modal.editService.title">Редактировать базар</h2>
                        </div>
                        <div class="admin-modal-actions">
                            <button id="closeEditServiceBtn" class="admin-modal-close">
                                <i class="fas fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="admin-modal-body">
                        <div class="admin-section">
                            <form id="editServiceForm" class="admin-form">
                                <input type="hidden" id="editServiceId" name="id">
                                
                                <!-- Основные поля -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editServiceName" data-i18n="modal.editService.serviceName">Название сервиса</label>
                                        <input type="text" id="editServiceName" name="name" data-i18n-placeholder="modal.editService.serviceNamePlaceholder" placeholder="Например: MIROBOD DEHQON BOZORI">
                                    </div>
                                    <div class="form-group">
                                        <label for="editServiceCity" data-i18n="modal.editService.city">Город</label>
                                        <input type="text" id="editServiceCity" name="city" data-i18n-placeholder="modal.editService.cityPlaceholder" placeholder="Например: Tashkent">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editServiceIp" data-i18n="modal.editService.ipAddress">IP адрес</label>
                                        <input type="text" id="editServiceIp" name="ip" placeholder="192.168.168.37">
                                    </div>
                                    <div class="form-group">
                                        <label for="editServicePort" data-i18n="modal.editService.frontendPort">Порт фронтенда</label>
                                        <input type="number" id="editServicePort" name="port" placeholder="80">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editServiceBackendPort" data-i18n="modal.editService.backendPort">Порт backend API</label>
                                        <input type="number" id="editServiceBackendPort" name="backend_port" placeholder="8200">
                                    </div>
                                    <div class="form-group">
                                        <label for="editServicePgPort" data-i18n="modal.editService.pgPort">Порт PostgreSQL</label>
                                        <input type="number" id="editServicePgPort" name="pg_port" placeholder="5400">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editServiceStreamPort" data-i18n="modal.editService.streamPort">Порт Stream</label>
                                        <input type="number" id="editServiceStreamPort" name="stream_port" placeholder="8554">
                                    </div>
                                    <div class="form-group">
                                        <!-- Empty column for alignment -->
                                    </div>
                                </div>
                            
                                <!-- Раскрывающаяся секция "Дополнительно" -->
                                <div class="form-collapsible">
                                    <button type="button" class="form-collapsible-toggle active" id="toggleEditAdditional">
                                        <i class="fas fa-chevron-down"></i>
                                        <span>Дополнительно (контакты, координаты)</span>
                                    </button>
                                    
                                    <div class="form-collapsible-content active" id="editAdditionalContent">
                                        <div class="form-section-title">
                                            <i class="fas fa-phone"></i>
                                            <h4>Контактная информация</h4>
                                        </div>
                                    
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="editServiceContactClickName" data-i18n="modal.editService.contactClickName">Имя контакта Click</label>
                                                <input type="text" id="editServiceContactClickName" name="contact_click_name" data-i18n-placeholder="modal.editService.contactClickNamePlaceholder" placeholder="Например: Иван Иванов">
                                            </div>
                                            <div class="form-group">
                                                <label for="editServiceContactClick" data-i18n="modal.editService.contactClick">Телефон Click</label>
                                                <div class="phone-input">
                                                    <span class="phone-prefix">+998</span>
                                                    <input type="tel" id="editServiceContactClick" name="contact_click" placeholder="901234567" pattern="[0-9]{9}" maxlength="9">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="editServiceContactSccName" data-i18n="modal.editService.contactSccName">Имя контакта SCC</label>
                                                <input type="text" id="editServiceContactSccName" name="contact_scc_name" data-i18n-placeholder="modal.editService.contactSccNamePlaceholder" placeholder="Например: Петр Петров">
                                            </div>
                                            <div class="form-group">
                                                <label for="editServiceContactScc" data-i18n="modal.editService.contactScc">Телефон SCC</label>
                                                <div class="phone-input">
                                                    <span class="phone-prefix">+998</span>
                                                    <input type="tel" id="editServiceContactScc" name="contact_scc" placeholder="901234567" pattern="[0-9]{9}" maxlength="9">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-section-title">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <h4 data-i18n="modal.editService.mapCoordinates">Координаты на карте</h4>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="editServiceLatitude" data-i18n="modal.editService.latitude">Широта</label>
                                                <input type="text" id="editServiceLatitude" name="latitude" placeholder="41.291173" pattern="^-?\d+\.?\d*$">
                                            </div>
                                            <div class="form-group">
                                                <label for="editServiceLongitude" data-i18n="modal.editService.longitude">Долгота</label>
                                                <input type="text" id="editServiceLongitude" name="longitude" placeholder="69.274854" pattern="^-?\d+\.?\d*$">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                    
                                <div class="form-actions" style="display: flex; gap: 0.75rem; justify-content: space-between;">
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button type="submit" class="btn-submit">
                                            <i class="fas fa-save"></i>
                                            <span>Сохранить изменения</span>
                                        </button>
                                        <button type="button" id="cancelEditService" class="btn-cancel">
                                            <i class="fas fa-times"></i>
                                            <span>Отмена</span>
                                        </button>
                                    </div>
                                    <button type="button" id="deleteEditService" class="btn-delete">
                                        <i class="fas fa-trash"></i>
                                        <span data-i18n="actions.delete">Удалить</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Modal -->
            <div id="logsModal" class="admin-modal">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <div class="admin-modal-title">
                            <i class="fas fa-list"></i>
                            <h2>Системные логи</h2>
                        </div>
                        <div class="admin-modal-actions">
                            <button id="closeLogsBtn" class="admin-modal-close">
                                <i class="fas fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="admin-modal-body">
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <div class="log-filters">
                                    <select id="logStatusFilter">
                                        <option value="">Все статусы</option>
                                        <option value="online">Online</option>
                                        <option value="offline">Offline</option>
                                    </select>
                                    <input type="number" id="logLimit" placeholder="Количество записей" value="50" min="1" max="1000">
                                    <button id="downloadLogsBtn" class="btn-download-logs" title="Скачать логи">
                                        <i class="fas fa-download"></i>
                                        <span>Скачать</span>
                                    </button>
                                </div>
                            </div>
                            <div id="logsList" class="logs-list">
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Загрузка логов...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Telegram Chat IDs Modal -->
            <div id="telegramChatIdsModal" class="admin-modal">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <div class="admin-modal-title">
                            <i class="fab fa-telegram"></i>
                            <h2 data-i18n="modal.telegram.title">Управление Telegram Chat ID</h2>
                        </div>
                        <div class="admin-modal-actions">
                            <button id="closeTelegramChatIdsBtn" class="admin-modal-close">
                                <i class="fas fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="admin-modal-body">
                        <div class="admin-section">
                            <h3 data-i18n="modal.telegram.addChatId">Добавить Chat ID</h3>
                            <form id="addChatIdForm" style="margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label for="chatIdInput" data-i18n="modal.telegram.chatId">Chat ID *</label>
                                    <input type="text" id="chatIdInput" data-i18n-placeholder="modal.telegram.chatIdPlaceholder" placeholder="@channel, @username или числовой ID" required>
                                    <small data-i18n="modal.telegram.chatIdHint">Можно использовать: числовой ID, @channel, @username</small>
                                </div>
                                <div class="form-group">
                                    <label data-i18n="modal.telegram.type">Тип</label>
                                    <div class="type-selector" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                        <button type="button" class="type-option active" data-type="channel" onclick="selectChatType('channel')" style="flex: 1; padding: 0.75rem; border: 2px solid var(--primary); border-radius: 6px; background: var(--primary); color: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 500;">
                                            <i class="fas fa-bullhorn"></i>
                                            <span data-i18n="modal.telegram.typeChannel">Канал</span>
                                        </button>
                                        <button type="button" class="type-option" data-type="group" onclick="selectChatType('group')" style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; background: var(--surface-color); color: var(--text-primary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                            <i class="fas fa-users"></i>
                                            <span data-i18n="modal.telegram.typeGroup">Группа</span>
                                        </button>
                                        <button type="button" class="type-option" data-type="user" onclick="selectChatType('user')" style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; background: var(--surface-color); color: var(--text-primary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                            <i class="fas fa-user"></i>
                                            <span data-i18n="modal.telegram.typeUser">Пользователь</span>
                                        </button>
                                    </div>
                                    <input type="hidden" id="chatTypeSelect" value="channel">
                                </div>
                                <div class="form-group">
                                    <label for="chatDescriptionInput" data-i18n="modal.telegram.description">Описание (опционально)</label>
                                    <input type="text" id="chatDescriptionInput" data-i18n-placeholder="modal.telegram.descriptionPlaceholder" placeholder="Например: Основной канал">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="modal.telegram.allowedRegions">Разрешенные области (оставьте пустым для всех областей)</label>
                                    <div id="regionsCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                                        <small style="color: var(--text-muted);" data-i18n="modal.telegram.loadingRegions">Загрузка областей...</small>
                                    </div>
                                </div>
                                <button type="submit" class="btn-submit">
                                    <i class="fas fa-plus"></i>
                                    <span data-i18n="modal.telegram.add">Добавить</span>
                                </button>
                            </form>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; margin-bottom: 1rem;">
                                <h3 style="margin: 0;" data-i18n="modal.telegram.chatIdsList">Список Chat ID</h3>
                                <button id="testTelegramNotificationBtn" class="btn-submit" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem;">
                                    <i class="fas fa-paper-plane"></i>
                                    <span data-i18n="modal.telegram.testNotification">Отправить тестовое уведомление</span>
                                </button>
                            </div>
                            <div id="chatIdsList" style="margin-top: 1rem;">
                                <!-- Список будет загружен динамически -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Chat ID Regions Modal -->
            <div id="editChatIdRegionsModal" class="admin-modal">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <div class="admin-modal-title">
                            <i class="fas fa-map-marker-alt"></i>
                            <h2 data-i18n="modal.telegram.editRegionsTitle">Настройка областей для Chat ID</h2>
                        </div>
                        <div class="admin-modal-actions">
                            <button id="closeEditRegionsBtn" class="admin-modal-close">
                                <i class="fas fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="admin-modal-body">
                        <div class="admin-section">
                            <p style="margin-bottom: 1rem; color: var(--text-muted);" data-i18n="modal.telegram.editRegionsDescription">
                                Выберите области, для которых этот Chat ID будет получать уведомления. 
                                Если ничего не выбрано, будут приходить уведомления со всех областей.
                            </p>
                            <div id="editRegionsCheckboxes" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                                <!-- Чекбоксы будут загружены динамически -->
                            </div>
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button id="saveRegionsBtn" class="btn-submit">
                                    <i class="fas fa-save"></i>
                                    <span data-i18n="modal.telegram.save">Сохранить</span>
                                </button>
                                <button id="cancelRegionsBtn" class="btn-cancel">
                                    <span data-i18n="modal.telegram.cancel">Отмена</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Markets Grid -->
            <section class="markets-section">
                <div class="section-title-bar">
                    <h2 data-i18n="dashboard.bazarsList">Список базаров</h2>
                    <div class="view-info">
                        <i class="fas fa-circle"></i>
                        <span data-i18n="dashboard.liveData">Live Data</span>
                    </div>
                </div>

                <div id="bazarsGrid" class="markets-grid">
                    <div class="loading-state">
                        <div class="modern-loader">
                            <div class="loader-ring"></div>
                            <div class="loader-ring"></div>
                            <div class="loader-ring"></div>
                            <div class="loader-core"></div>
                        </div>
                        <div class="loading-info">
                            <p class="loading-title">Establishing Connection</p>
                            <p class="loading-subtitle">Fetching bozor data...</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <p class="progress-text">0 / 0</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="script.js"></script>
</body>
</html>
